var endpoint = "http://127.0.0.1:8000"
// access_token is used to login to alpha
var oauth_code = ""
var events_token = ""
function clickEvent(){
    sign_in_btn();
}

function login(user_code) {
    console.log(user_code);
    var query =`mutation Mymutation($codeToken: String!) {
                    expaLogin(codeToken:$codeToken, type:"OGX")
                    { 
                        user
                        {
                            profile
                            {
                                firstName
                            }
                        }
                        token
                    }
                }`;
    
    var variables = { codeToken: user_code.toString() },
    
    data_ = fetch(endpoint + '/graphql', {
                method: 'POST',
                headers:{
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                body: JSON.stringify({
                            query,
                            variables,
                        })
            })
            .then(r => r.json())
            .then(data => validate_login(data));
}

function validate_login(data){
    console.log(data);
    if (data['data']['expaLogin'] != null)
    {
        setCookie("events_token", data['data']['expaLogin']['token'], 1);
        location.reload();
    }
    else
    {
        console.log("unsuccessful login!");
    }
}

function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    var expires = "expires="+ d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}  

// this access_token is the alpha_token cookie that is generated by jwt in alpha backend
function get_current_user(access_token){
    var query =`query Myquery {
                    currentuser
                    {
                        id
                        profile
                        {
                            firstName
                        }
                    }
                }`;

    data_ = fetch(endpoint + '/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': 'JWT ' + access_token,
                },
                body: JSON.stringify({
                    query,
                })
            })
            .then(r => r.json())
            .then(data => console.log(data));
}

var windowObjectReference = null;
var sensor = null;

// works only on websites that have the same domain
function check_auth() {
    console.log(windowObjectReference.location.href);
    if (String(windowObjectReference.location.href).indexOf("code=") > -1) {
        console.log(windowObjectReference.location.href)
        var auth_code = String(windowObjectReference.location.href).split("?code=")[1]
        windowObjectReference.close();
        login(auth_code);
    }
    if (windowObjectReference.closed) {
        clearInterval(sensor);
    }
}


function sign_in_btn(){
    // the redirect uri should be registered on aiesec.org before using
    windowObjectReference = window.open(
        "https://auth.aiesec.org/oauth/authorize?response_type=code&client_id=6a1dff3bc3c7fa6e1aea0b3d1e89683cfe1c9bf8517b82b26ecd0f34fa5c45db&redirect_uri=http%3A%2F%2F127.0.0.1:8000%2F", "Authorization", "resizable,scrollbars,status"
    );
    sensor = setInterval(check_auth, 1000);
}	